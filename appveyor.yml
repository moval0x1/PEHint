# AppVeyor CI configuration for PEHint

version: 1.0.{build}
image: Visual Studio 2022

environment:
  QT_INSTALL_DIR: "C:\\Qt"
  QT_VERSION: "6.5.2"

cache:
  - C:\Qt

install:
  # Install curl using Chocolatey
  - choco install curl --yes

  # Debug environment variables
  - echo Debugging environment variables...
  - echo QT_INSTALL_DIR=%QT_INSTALL_DIR%
  - echo QT_VERSION=%QT_VERSION%

  # Create the QT_INSTALL_DIR if it doesn't exist
  - cmd: |
      echo Ensuring %QT_INSTALL_DIR% exists...
      IF NOT EXIST "%QT_INSTALL_DIR%" mkdir "%QT_INSTALL_DIR%"

  # Check and install Qt if not already installed
  - cmd: |
      echo Checking if Qt %QT_VERSION% is installed at %QT_INSTALL_DIR%...
      IF NOT EXIST "%QT_INSTALL_DIR%\%QT_VERSION%" (
        echo "Qt not found. Downloading and installing..."
        curl -Lo qt-installer.exe https://download.qt.io/official_releases/online_installers/qt-unified-windows-x86-online.exe
        qt-installer.exe --script qt-install-script.qs
        IF %ERRORLEVEL% NEQ 0 (
          echo "Qt installation failed. Exiting..."
          exit /b %ERRORLEVEL%
        )
      ) ELSE (
        echo "Qt %QT_VERSION% is already installed at %QT_INSTALL_DIR%."
      )

  # Verify Qt installation
  - cmd: |
      echo Verifying Qt installation...
      IF EXIST "%QT_INSTALL_DIR%\%QT_VERSION%" (
        echo "Qt installation verified successfully."
      ) ELSE (
        echo "Qt installation missing. Exiting with error."
        exit /b 1
      )

build_script:
  # Create build directory and configure project
  - cmd: mkdir build
  - cmd: cd build
  - cmd: cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=%QT_INSTALL_DIR%\%QT_VERSION%\msvc2019_64 ..
  - cmd: cmake --build . --config Release

test_script:
  # Run tests
  - cmd: cd build
  - cmd: ctest --output-on-failure

artifacts:
  # Collect compiled executables
  - path: build\Release\*.exe
    name: PEHint Executables
