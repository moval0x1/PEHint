# AppVeyor CI configuration for PEHint

version: 1.0.{build}
image: Visual Studio 2022

environment:
  QT_INSTALL_DIR: "C:\\Qt"
  QT_VERSION: "6.5.2"

cache:
  - C:\Qt

install:
  # Install curl using Chocolatey
  - choco install curl --yes
  
  # Debug environment variables
  - echo QT_INSTALL_DIR=%QT_INSTALL_DIR%
  - echo QT_VERSION=%QT_VERSION%

  # Check if Qt is already installed, download and install if not
  - cmd: |
      set QT_INSTALL_DIR=C:\Qt
      if not exist %QT_INSTALL_DIR%\%QT_VERSION% (
        curl -Lo qt-installer.exe https://download.qt.io/official_releases/online_installers/qt-unified-windows-x86-online.exe
        qt-installer.exe --script qt-install-script.qs
      ) else (
        echo "Qt already installed."
      )

  # Verify the Qt installation
  - cmd: |
      if exist C:\Qt\6.5.2 (
        echo "Qt installation verified at C:\Qt\6.5.2."
      ) else (
        echo "Qt installation failed. Check previous steps."
        exit 1
      )

build_script:
  # Create build directory and configure project
  - cmd: mkdir build
  - cmd: cd build
  - cmd: cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=C:\Qt\6.5.2\msvc2019_64 ..
  - cmd: cmake --build . --config Release

test_script:
  - cmd: cd build
  - cmd: ctest --output-on-failure

artifacts:
  - path: build\Release\*.exe
    name: PEHint Executables