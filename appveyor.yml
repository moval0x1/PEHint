# AppVeyor configuration for PEHint project

version: '{branch}.{build}'
skip_tags: true

# Set the environment to Windows
image: Visual Studio 2019

platform:
  - x64
  
configuration:
  - Release

branches:
  only:
    - update-layout-structure

build:
  verbosity: detailed

# Install and detect Qt
install:
  - ps: |
      $qtDirs = Get-ChildItem -Directory C:\Qt | Where-Object { $_.Name -match '6.*' }
      if ($qtDirs.Count -eq 0) {
          Write-Host "No Qt 6.x installation found. Installing Qt 6.7.2..."
          $qtInstallerUrl = "https://download.qt.io/official_releases/online_installers/qt-unified-windows-x64-online.exe"
          $qtInstallerPath = "$env:TEMP\qt-unified-windows-x64-online.exe"
          Invoke-WebRequest -Uri $qtInstallerUrl -OutFile $qtInstallerPath
          Start-Process -Wait -FilePath $qtInstallerPath -ArgumentList "--silent", "--platform minimal", "--root C:\Qt", "--modules qt.qt6.670.win64_msvc2019_64"
      } else {
          $qtVersion = $qtDirs[-1].FullName
          $qtConfigPath = Get-ChildItem -Recurse -Filter "Qt6Config.cmake" "$qtVersion" | Select-Object -First 1
          if ($qtConfigPath -and $qtConfigPath.DirectoryName) {
              Write-Host "Using Qt installation at: $($qtConfigPath.DirectoryName)"
              [Environment]::SetEnvironmentVariable("QT_DIR", $qtConfigPath.DirectoryName, "Process")
          } else {
              Write-Host "Could not find Qt6Config.cmake in $qtVersion"
              exit 1
          }
      }

# Clone the repository
clone_folder: c:\projects\pehint

# Before build: set up environment
before_build:
  - echo CMAKE_PREFIX_PATH=%CMAKE_PREFIX_PATH%
  - echo QT_DIR="%QT_DIR%"
  - dir "%QT_DIR%"
  - set CMAKE_PREFIX_PATH=%QT_DIR%
  - cmake -B build -S . -DCMAKE_PREFIX_PATH=%CMAKE_PREFIX_PATH% -G "Visual Studio 16 2019" -A x64

# Build script
build_script:
  - cmake --build build --config Release

# Artifacts: include the final executable for download
artifacts:
  - path: build\Release\PEHint.exe
    name: PEHint Executable
