# AppVeyor CI configuration for PEHint

version: '{branch}.{build}'
skip_tags: true

image:
- Visual Studio 2022

platform:
  - x64
  - x86

configuration:
  - Release
  - Debug

branches:
  only:
    - update-layout-structure

build:
  verbosity: detailed

environment:
  QT_VERSION: 6.5.2
  artifactName: $(APPVEYOR_PROJECT_NAME)-$(APPVEYOR_REPO_COMMIT)-$(CONFIGURATION)-$(PLATFORM)
  buildConfig: $(CONFIGURATION)
  buildPlatform: $(PLATFORM)

install:
  # Set Qt paths dynamically based on platform
  - ps: |
      if ($env:buildPlatform -eq "x64") {
        $env:QT="C:\Qt\$env:QT_VERSION\msvc2019_64"
      } elseif ($env:buildPlatform -eq "x86") {
        $env:QT="C:\Qt\$env:QT_VERSION\msvc2019"
      }
      $env:QT_DIR=$env:QT
      $env:PATH="$env:PATH;$env:QT\bin"

before_build:
  # Debug paths
  - echo Using Qt from %QT_DIR%
  - dir %QT_DIR%\lib\cmake

  # Verify necessary Qt configuration files
  - ps: |
      if (-not (Test-Path "$env:QT_DIR\lib\cmake\Qt6Config.cmake")) {
        Write-Host "Error: Qt6Config.cmake not found in $env:QT_DIR\lib\cmake"
        Exit 1
      }

  # Create build directory
  - cmd: mkdir build
  - cmd: cd build

build_script:
  # Configure the project using CMake
  - cmd: |
      if "%buildPlatform%"=="x64" (
        cmake .. -A x64 -DCMAKE_PREFIX_PATH="%QT_DIR%\lib\cmake" -DCMAKE_BUILD_TYPE=%buildConfig%
      ) else (
        cmake .. -A Win32 -DCMAKE_PREFIX_PATH="%QT_DIR%\lib\cmake" -DCMAKE_BUILD_TYPE=%buildConfig%
      )

  # Build the executable
  - cmd: cmake --build . --config %buildConfig%

after_build:
  # Collect the .exe file as an artifact
  - cmd: |
      mkdir %artifactName%
      copy %buildConfig%\PEHint.exe %artifactName%

artifacts:
  # Specify the artifact path
  - path: build\%artifactName%
    name: PEHint Executables
