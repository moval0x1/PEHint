# AppVeyor CI configuration for PEHint

version: '{branch}.{build}'
skip_tags: true

image:
- Visual Studio 2022

platform:
  - x64
  - x86

configuration:
  - Release
  - Debug

branches:
  only:
    - main

build:
  verbosity: detailed

environment:
  QT_VERSION: 6.5.2
  artifactName: $(APPVEYOR_PROJECT_NAME)-$(APPVEYOR_REPO_COMMIT)-$(CONFIGURATION)-$(PLATFORM)
  buildConfig: $(CONFIGURATION)
  buildPlatform: $(PLATFORM)

install:
  # Update Git submodules
  - git submodule update --init --recursive

  # Set Qt paths dynamically based on platform
  - if [%buildPlatform%]==[x64] (set QT=C:\Qt\%QT_VERSION%\msvc2019_64)
  - if [%buildPlatform%]==[x86] (set QT=C:\Qt\%QT_VERSION%\msvc2019)
  - set QT_DIR=%QT%
  - set PATH=%PATH%;%QT%\bin

before_build:
  # Debug paths
  - echo Using Qt from %QT_DIR%
  - dir %QT_DIR%\lib\cmake

  # Verify necessary Qt configuration files
  - if not exist "%QT_DIR%\lib\cmake\Qt6Config.cmake" (
      echo "Error: Qt6Config.cmake not found in %QT_DIR%\lib\cmake"
      exit /b 1
    )

  # Create build directory
  - mkdir build
  - cd build

build_script:
  # Configure the project using CMake
  - if [%buildPlatform%]==[x64] (
      cmake .. -A x64 -DCMAKE_PREFIX_PATH="%QT_DIR%\lib\cmake" -DCMAKE_BUILD_TYPE=%buildConfig%
    )
  - if [%buildPlatform%]==[x86] (
      cmake .. -A Win32 -DCMAKE_PREFIX_PATH="%QT_DIR%\lib\cmake" -DCMAKE_BUILD_TYPE=%buildConfig%
    )

  # Build the executable
  - cmake --build . --config %buildConfig%

after_build:
  # Collect the .exe file as an artifact
  - mkdir %artifactName%
  - cp %buildConfig%\PEHint.exe %artifactName%

artifacts:
  # Specify the artifact path
  - path: build\%artifactName%
    name: PEHint Executables
