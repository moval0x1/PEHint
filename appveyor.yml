# AppVeyor CI configuration for PEHint

version: 1.0.{build}
image: Visual Studio 2022

environment:
  QT_INSTALL_DIR: "C:\\Qt"
  QT_VERSION: "6.5.2"

cache:
  - C:\Qt

install:
  # Install curl using Chocolatey
  - choco install curl --yes
  
  # Debug environment variables
  - echo QT_INSTALL_DIR=%QT_INSTALL_DIR%
  - echo QT_VERSION=%QT_VERSION%

  # Check and install Qt if not present
  - cmd: |
      echo Checking if Qt is already installed...
      IF NOT EXIST "%QT_INSTALL_DIR%\%QT_VERSION%" (
        echo "Qt not found at %QT_INSTALL_DIR%\%QT_VERSION%. Starting installation..."
        curl -Lo qt-installer.exe https://download.qt.io/official_releases/online_installers/qt-unified-windows-x86-online.exe
        qt-installer.exe --script qt-install-script.qs
        IF %ERRORLEVEL% NEQ 0 (
          echo "Qt installation failed. Exiting..."
          exit /b %ERRORLEVEL%
        )
      ) ELSE (
        echo "Qt already installed at %QT_INSTALL_DIR%\%QT_VERSION%."
      )

  # Verify Qt installation
  - cmd: |
      echo Verifying Qt installation...
      IF EXIST "%QT_INSTALL_DIR%\%QT_VERSION%" (
        echo "Qt installation verified at %QT_INSTALL_DIR%\%QT_VERSION%."
      ) ELSE (
        echo "Qt installation missing. Exiting with error."
        exit /b 1
      )

build_script:
  # Create build directory and configure project
  - cmd: mkdir build
  - cmd: cd build
  - cmd: cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=C:\Qt\%QT_VERSION%\msvc2019_64 ..
  - cmd: cmake --build . --config Release

test_script:
  # Run tests
  - cmd: cd build
  - cmd: ctest --output-on-failure

artifacts:
  # Collect compiled executables
  - path: build\Release\*.exe
    name: PEHint Executables